<div class="overflow-hidden rounded-2xl border border-gray-200 bg-white px-4 pb-3 pt-4 mt-5 dark:border-gray-800 dark:bg-white/3 sm:px-6">
  <div class="flex flex-col gap-2 mb-4 sm:flex-row sm:items-center sm:justify-between">
    <div>
      <h3 class="text-lg font-semibold text-gray-800 dark:text-white/90">Temas</h3>
    </div>
    <div class="flex items-center gap-3">
  <a href="/admin/themes/customize"
        class="inline-flex items-center gap-2 rounded-lg border border-brand-300 bg-white px-4 py-2.5 text-theme-sm font-medium text-brand-700 shadow-theme-xs hover:bg-brand-50 hover:text-brand-800 dark:border-brand-700 dark:bg-brand-800 dark:text-brand-400 dark:hover:bg-white/[0.03] dark:hover:text-brand-200">
        ðŸŽ¨ Visual Customizer
      </a>
  <button type="button" (click)="openNew()"
        class="inline-flex items-center gap-2 rounded-lg border border-brand-300 bg-white px-4 py-2.5 text-theme-sm font-medium text-brand-700 shadow-theme-xs hover:bg-brand-50 hover:text-brand-800 dark:border-brand-700 dark:bg-brand-800 dark:text-brand-400 dark:hover:bg-white/[0.03] dark:hover:text-brand-200">
        Nuevo tema
      </button>
    </div>
  </div>

  @if (success()) {
  <app-admin-alert [variant]="'success'" title="Ã‰xito" [message]="success()!" (closed)="success.set(null)" />
  }
  @if (error()) {
  <app-admin-alert [variant]="'error'" title="Error" [message]="error()!" (closed)="error.set(null)" />
  }

  @if (showNew()) {
  <div class="border rounded p-3 bg-white/70 dark:bg-gray-800/70 border-gray-300 dark:border-gray-600 transition-colors mb-4">
    <div class="flex items-center justify-between">
      <h4 class="font-medium text-sm">Nuevo tema</h4>
      <button type="button" (click)="closeNew()" class="text-xs text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">Cerrar</button>
    </div>
    <form class="mt-3 space-y-3" (ngSubmit)="createNew()" #newForm="ngForm">
      <div class="flex flex-wrap gap-4">
        <div>
          <label for="newName" class="mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400">Nombre *</label>
          <input id="newName" name="name" required minlength="2" [(ngModel)]="newTheme.name"
            class="dark:bg-dark-900 shadow-theme-xs focus:border-brand-300 focus:ring-brand-500/10 dark:focus:border-brand-800 h-10 w-full appearance-none rounded-lg border border-gray-300 bg-transparent bg-none px-3 text-sm text-gray-800 placeholder:text-gray-400 focus:ring-3 focus:outline-hidden dark:border-gray-700 dark:bg-gray-900 dark:text-white/90 dark:placeholder:text-white/30" />
        </div>
        <div>
          <label for="newPrimary" class="mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400">Primario</label>
          <input id="newPrimary" name="primaryColor" type="text" placeholder="#ffcc00" [(ngModel)]="newTheme.primaryColor" pattern="^#([0-9A-Fa-f]{3}|[0-9A-Fa-f]{6})$"
            class="h-10 w-28 dark:bg-dark-900 shadow-theme-xs focus:border-brand-300 focus:ring-brand-500/10 dark:focus:border-brand-800 appearance-none rounded-lg border border-gray-300 bg-transparent bg-none px-3 text-sm text-gray-800 placeholder:text-gray-400 focus:ring-3 focus:outline-hidden dark:border-gray-700 dark:bg-gray-900 dark:text-white/90 dark:placeholder:text-white/30" [class.border-red-500]="newTheme.primaryColor && !isValidHex(newTheme.primaryColor)" />
          <p *ngIf="newTheme.primaryColor && !isValidHex(newTheme.primaryColor)" class="text-[10px] text-red-600 mt-1">Formato hex invÃ¡lido</p>
        </div>
        <div>
          <label for="newSecondary" class="mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400">Secundario</label>
          <input id="newSecondary" name="secondaryColor" type="text" placeholder="#111827" [(ngModel)]="newTheme.secondaryColor" pattern="^#([0-9A-Fa-f]{3}|[0-9A-Fa-f]{6})$"
            class="h-10 w-28 dark:bg-dark-900 shadow-theme-xs focus:border-brand-300 focus:ring-brand-500/10 dark:focus:border-brand-800 appearance-none rounded-lg border border-gray-300 bg-transparent bg-none px-3 text-sm text-gray-800 placeholder:text-gray-400 focus:ring-3 focus:outline-hidden dark:border-gray-700 dark:bg-gray-900 dark:text-white/90 dark:placeholder:text-white/30" [class.border-red-500]="newTheme.secondaryColor && !isValidHex(newTheme.secondaryColor)" />
          <p *ngIf="newTheme.secondaryColor && !isValidHex(newTheme.secondaryColor)" class="text-[10px] text-red-600 mt-1">Formato hex invÃ¡lido</p>
        </div>
      </div>
      <div>
        <label for="newCss" class="mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400">Custom CSS</label>
        <textarea id="newCss" name="customCss" rows="3" [(ngModel)]="newTheme.customCss"
          class="w-full font-mono text-xs dark:bg-dark-900 shadow-theme-xs focus:border-brand-300 focus:ring-brand-500/10 dark:focus:border-brand-800 appearance-none rounded-lg border border-gray-300 bg-transparent bg-none px-3 py-2 text-sm text-gray-800 placeholder:text-gray-400 focus:ring-3 focus:outline-hidden dark:border-gray-700 dark:bg-gray-900 dark:text-white/90 dark:placeholder:text-white/30"></textarea>
      </div>
      <div class="flex gap-2">
  <button class="inline-flex items-center gap-2 rounded-lg border border-brand-300 bg-white px-4 py-2.5 text-theme-sm font-medium text-brand-700 shadow-theme-xs hover:bg-brand-50 hover:text-brand-800 disabled:opacity-40 dark:border-brand-700 dark:bg-brand-800 dark:text-brand-400 dark:hover:bg-white/[0.03] dark:hover:text-brand-200" type="submit" [appLoading]="creating()" [disabled]="creating() || newForm.invalid || !colorsValid(newTheme.primaryColor, newTheme.secondaryColor)">Crear</button>
        <button class="px-3 py-1 rounded-lg border border-gray-300 bg-white px-4 py-2.5 text-theme-sm font-medium text-gray-700 shadow-theme-xs hover:bg-gray-50 hover:text-gray-800 dark:border-gray-700 dark:bg-gray-800 dark:text-gray-400 dark:hover:bg-white/[0.03] dark:hover:text-gray-200" type="button" (click)="resetNew()" [disabled]="creating()">Limpiar</button>
      </div>
      <div *ngIf="createError()" class="text-xs text-red-600">{{createError()}}</div>
    </form>
  </div>
  }

  <div class="w-full overflow-x-auto">
    <table class="min-w-full">
      <thead>
        <tr class="border-gray-100 border-y dark:border-gray-800">
          <th class="py-3"><div class="flex items-center"><p class="font-medium text-gray-500 text-theme-xs dark:text-gray-400">Nombre</p></div></th>
          <th class="py-3"><div class="flex items-center"><p class="font-medium text-gray-500 text-theme-xs dark:text-gray-400">Colores</p></div></th>
          <th class="py-3"><div class="flex items-center"><p class="font-medium text-gray-500 text-theme-xs dark:text-gray-400">Activo</p></div></th>
          <th class="py-3"><div class="flex items-center"><p class="font-medium text-gray-500 text-theme-xs dark:text-gray-400">Editar</p></div></th>
          <th class="py-3 w-[20px]"><div class="flex items-center"><p class="font-medium text-gray-500 text-theme-xs dark:text-gray-400">Acciones</p></div></th>
        </tr>
      </thead>
      <tbody class="divide-y divide-gray-100 dark:divide-gray-800">
        @for (t of themes(); track t.id) {
        <tr>
          <td class="py-3">
            <div class="flex items-center">
              <p class="text-gray-500 text-theme-sm dark:text-gray-400">{{t.name}}</p>
            </div>
          </td>
          <td class="py-3">
            <div class="flex items-center gap-2">
              @if (t.primaryColor) { <span class="inline-block w-5 h-5 rounded border" [style.background]="t.primaryColor"></span> }
              @if (t.secondaryColor) { <span class="inline-block w-5 h-5 rounded border" [style.background]="t.secondaryColor"></span> }
            </div>
          </td>
          <td class="py-3">
            @if (t.isActive) {
            <span class="text-green-600 font-semibold">SÃ­</span>
            } @else {
            <button class="text-xs text-blue-600 underline" (click)="activate(t)" [appLoading]="activatingId()===t.id" [disabled]="activatingId()===t.id">Activar</button>
            }
          </td>
          <td class="py-3 align-top">
            <div class="space-y-2">
              <details>
                <summary class="cursor-pointer select-none text-xs text-neutral-700 dark:text-neutral-300">Editar</summary>
                <form class="mt-2 space-y-2" (ngSubmit)="save(t)" #f="ngForm">
                  <div class="flex items-center gap-2">
                    <label [attr.for]="'p-'+t.id" class="w-24 text-xs text-neutral-600">Primario</label>
                    <input [attr.id]="'p-'+t.id" type="text" name="primaryColor" [(ngModel)]="t.primaryColor" placeholder="#ffcc00" class="h-8 w-28 border rounded px-2 text-xs bg-white dark:bg-gray-800 border-gray-300 dark:border-gray-600 transition-colors" [class.border-red-500]="t.primaryColor && !isValidHex(t.primaryColor)" />
                  </div>
                  <div class="flex items-center gap-2">
                    <label [attr.for]="'s-'+t.id" class="w-24 text-xs text-neutral-600">Secundario</label>
                    <input [attr.id]="'s-'+t.id" type="text" name="secondaryColor" [(ngModel)]="t.secondaryColor" placeholder="#000000" class="h-8 w-28 border rounded px-2 text-xs bg-white dark:bg-gray-800 border-gray-300 dark:border-gray-600 transition-colors" [class.border-red-500]="t.secondaryColor && !isValidHex(t.secondaryColor)" />
                  </div>
                  <div>
                    <label [attr.for]="'css-'+t.id" class="block text-xs text-neutral-600 mb-1">Custom CSS</label>
                    <textarea [attr.id]="'css-'+t.id" name="customCss" [(ngModel)]="t.customCss" rows="4" class="w-full font-mono text-xs border rounded p-2 bg-white dark:bg-gray-800 border-gray-300 dark:border-gray-600 transition-colors"></textarea>
                  </div>
                  <div class="flex gap-2">
                    <button class="btn btn-xs" type="submit" [appLoading]="savingId()===t.id" [disabled]="savingId()===t.id || !colorsValid(t.primaryColor, t.secondaryColor)">Guardar</button>
                    <button class="btn btn-xs" type="button" (click)="saveAndActivate(t)" [appLoading]="savingId()===t.id || activatingId()===t.id" [disabled]="savingId()===t.id || activatingId()===t.id || !colorsValid(t.primaryColor, t.secondaryColor)">Guardar y activar</button>
                    <button type="button" class="btn btn-xs" (click)="preview(t)">{{ previewingId()===t.id ? 'Cerrar' : 'Preview' }}</button>
                  </div>
                  <p *ngIf="(t.primaryColor && !isValidHex(t.primaryColor)) || (t.secondaryColor && !isValidHex(t.secondaryColor))" class="text-[10px] text-red-600">Corregir colores hex (#RGB o #RRGGBB).</p>
                </form>
              </details>
            </div>
          </td>
          <td class="py-3 align-top">
            <div class="flex items-center">
              <div class="inline-flex items-center shadow-theme-xs">
                <button type="button" (click)="duplicate(t)" [appLoading]="duplicatingId()===t.id"
                  class="-ml-px inline-flex items-center gap-2 bg-transparent px-4 py-3 text-sm font-medium text-brand-500 ring-1 ring-inset ring-brand-500 first:rounded-l-lg last:rounded-r-lg hover:bg-brand-500 hover:text-white">Duplicar</button>
                <button type="button" (click)="delete(t)" [appLoading]="deletingId()===t.id" [disabled]="deletingId()===t.id"
                  class="-ml-px inline-flex items-center gap-2 bg-transparent px-4 py-3 text-sm font-medium text-red-500 ring-1 ring-inset ring-red-500 first:rounded-l-lg last:rounded-r-lg hover:bg-red-500 hover:text-white disabled:opacity-40">Eliminar</button>
              </div>
            </div>
          </td>
        </tr>
        }

        @if (!loading() && themes().length===0 ) {
        <tr>
          <td colspan="5" class="py-3">
            <div class="flex items-center">
              <p class="text-gray-500 text-theme-sm dark:text-gray-400">Sin registros</p>
            </div>
          </td>
        </tr>
        }
        @if (loading()) {
        <tr>
          <td colspan="5" class="py-8">
            <div class="flex items-center justify-center gap-2 text-gray-500 dark:text-gray-400">
              <app-spinner size="sm" label="Cargando temas"></app-spinner>
              <span class="text-theme-sm">Cargandoâ€¦</span>
            </div>
          </td>
        </tr>
        }
      </tbody>
    </table>
  </div>
</div>
