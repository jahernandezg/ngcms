name: Deploy Frontend (Shared Hosting)

on:
  push:
    branches: [ main ]
    paths:
      - 'frontend/**'
      - 'libs/**'
      - 'package.json'
      - 'package-lock.json'
      - 'nx.json'
      - 'tsconfig.base.json'
      - '.github/workflows/deploy-frontend.yml'
  workflow_dispatch:

concurrency:
  group: deploy-frontend-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    env:
      OPENAPI_URL: ${{ vars.OPENAPI_URL }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --no-audit --no-fund --legacy-peer-deps

      - name: Generate OpenAPI types (from live API)
        run: |
          set -e
          URL="${OPENAPI_URL:-https://api.tsinit.com/api/docs-json}"
          echo "Fetching OpenAPI from $URL"
          if curl -fsSL "$URL" -o swagger.json; then
            npx openapi-typescript swagger.json --output libs/shared-types/src/lib/openapi-types.ts
          else
            echo "Warning: cannot fetch OpenAPI JSON; generating placeholder types"
            mkdir -p libs/shared-types/src/lib
            printf "export {}\n" > libs/shared-types/src/lib/openapi-types.ts
          fi

      - name: Disable openapi:all during Nx codegen (CI)
        run: |
          node -e "const fs=require('fs');const p=JSON.parse(fs.readFileSync('package.json','utf8'));p.scripts=p.scripts||{};p.scripts['openapi:all']='echo openapi generation skipped in deploy-frontend';fs.writeFileSync('package.json',JSON.stringify(p,null,2));"

      - name: Build Angular frontend (static)
        run: |
          npm run build:frontend
          ls -la dist/frontend || true
          test -d dist/frontend/browser

      - name: Crear env.js (runtime config)
        shell: bash
        run: |
          set -e
          # Genera un archivo de runtime config dentro del build estÃ¡tico
          mkdir -p dist/frontend/browser
          cat > dist/frontend/browser/env.js << 'EOF'
          window.__ENV__ = {
            OPENAPI_URL: ${{ toJSON(vars.OPENAPI_URL) }},
            API_URL: ${{ toJSON(vars.API_URL) }},
            SENTRY_DSN: ${{ toJSON(secrets.SENTRY_DSN) }},
            COMMIT_SHA: ${{ toJSON(github.sha) }}
          };
          EOF
          echo "env.js generado en dist/frontend/browser/env.js"
          ls -l dist/frontend/browser/env.js

      - name: Deploy via FTP/FTPS
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.FTP_HOST }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          protocol: 'ftp'
          port: ${{ secrets.FTP_PORT || 21 }}
          server-dir: ${{ secrets.FTP_REMOTE_DIR }}
          local-dir: dist/frontend/browser/
          log-level: standard
          dry-run: false
          # Limpiar la carpeta remota antes de subir (elimina archivos que no existan en el build)
          # PRESERVANDO env.js (si existe en el hosting)
          dangerous-clean-slate: true
          exclude: |
            **/.git*
            **/.DS_Store

      # Alternative SFTP deploy (commented). Uncomment and remove the FTP step above if using SFTP.
      # - name: Deploy via SFTP
      #   uses: wlixcc/SFTP-Deploy-Action@v1.2.4
      #   with:
      #     server: ${{ secrets.SSH_HOST }}
      #     username: ${{ secrets.SSH_USER }}
      #     ssh_private_key: ${{ secrets.SSH_KEY }}
      #     local_path: dist/frontend/browser/*
      #     remote_path: ${{ secrets.SSH_REMOTE_DIR }}
      #     delete_remote_files: false
